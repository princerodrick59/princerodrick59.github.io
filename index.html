<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>FRC 1792 Scouting — 2026 REBUILT</title>
    <style>
        :root{
            --bg:#0b1020;
            --card:#111a33;
            --card2:#0f1730;
            --text:#eaf0ff;
            --muted:#a9b6e6;
            --accent:#1d5cff;
            --accent2:#0039A2;
            --danger:#ff3b3b;
            --ok:#21c55d;
            --warning:#ffb020;
            --border: rgba(255,255,255,.10);
            --shadow: 0 12px 30px rgba(0,0,0,.35);
            --radius: 18px;
            --tap: 52px;
            --font: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        *{box-sizing:border-box}
        body{
            margin:0;
            font-family: var(--font);
            background: radial-gradient(1200px 600px at 30% -20%, rgba(29,92,255,.35), transparent 60%),
            radial-gradient(900px 500px at 110% 10%, rgba(0,57,162,.25), transparent 55%),
            var(--bg);
            color: var(--text);
            min-height:100vh;
            -webkit-tap-highlight-color: transparent;
        }
        header{
            position: sticky; top:0;
            backdrop-filter: blur(10px);
            background: rgba(11,16,32,.75);
            border-bottom: 1px solid var(--border);
            z-index: 10;
        }
        .topbar{
            max-width: 920px;
            margin: 0 auto;
            padding: 14px 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
        }
        .brand{
            display:flex; flex-direction:column; gap:2px;
            line-height:1.1;
        }
        .brand .t1{font-weight:800; letter-spacing:.2px}
        .brand .t2{color:var(--muted); font-size:.92rem}
        .pill{
            display:flex; align-items:center; gap:10px;
            color: var(--muted);
            font-size:.9rem;
            white-space:nowrap;
        }
        .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25)}
        .dot.ok{background: rgba(33,197,93,.95)}
        .dot.bad{background: rgba(255,59,59,.95)}

        main{
            max-width: 920px;
            margin: 0 auto;
            padding: 16px;
        }

        .card{
            background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow:hidden;
        }
        .card .hd{
            padding: 16px 16px 8px 16px;
            display:flex;
            justify-content:space-between;
            gap: 12px;
            align-items:flex-start;
            border-bottom: 1px solid rgba(255,255,255,.06);
            background: rgba(255,255,255,.02);
        }
        .card .hd h2{
            margin: 0;
            font-size: 1.2rem;
            letter-spacing:.2px;
        }
        .card .hd p{
            margin: 6px 0 0 0;
            color: var(--muted);
            font-size:.95rem;
        }
        .card .bd{ padding: 16px; }

        .grid{
            display:grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 12px;
        }
        .col-12{grid-column: span 12;}
        .col-6{grid-column: span 6;}
        .col-4{grid-column: span 4;}
        .col-3{grid-column: span 3;}
        @media (max-width: 720px){
            .col-6,.col-4,.col-3{grid-column: span 12;}
        }

        label{
            display:block;
            font-size:.9rem;
            color: var(--muted);
            margin-bottom: 6px;
            font-weight: 600;
        }
        input, select, textarea{
            width:100%;
            padding: 14px 14px;
            background: rgba(0,0,0,.18);
            color: var(--text);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 14px;
            outline: none;
            font-size: 1rem;
            font-family: var(--font);
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        select{
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23eaf0ff' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
            cursor: pointer;
        }
        select option{
            background: #0b1020;
            color: var(--text);
            padding: 10px;
        }
        textarea{ min-height: 110px; resize: vertical; }
        input:focus, select:focus, textarea:focus{
            border-color: rgba(29,92,255,.65);
            box-shadow: 0 0 0 3px rgba(29,92,255,.18);
        }

        .autocomplete-wrapper{
            position: relative;
        }
        .autocomplete-results{
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(11,16,32,.98);
            border: 1px solid rgba(255,255,255,.18);
            border-radius: 14px;
            margin-top: 4px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow);
        }
        .autocomplete-results.show{
            display: block;
        }
        .autocomplete-item{
            padding: 12px 14px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,.06);
            transition: background 0.15s;
        }
        .autocomplete-item:last-child{
            border-bottom: none;
        }
        .autocomplete-item:hover, .autocomplete-item.active{
            background: rgba(29,92,255,.2);
        }
        .autocomplete-item .team-num{
            font-weight: 800;
            color: var(--text);
        }
        .autocomplete-item .team-name{
            font-size: .9rem;
            color: var(--muted);
            margin-top: 2px;
        }

        .row{
            display:flex; gap:12px; flex-wrap:wrap;
            align-items:center;
        }
        .btn{
            height: var(--tap);
            padding: 0 16px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.16);
            background: rgba(29,92,255,.18);
            color: var(--text);
            font-weight: 700;
            font-size: 1rem;
            cursor:pointer;
            display:inline-flex;
            align-items:center;
            justify-content:center;
            gap: 10px;
            user-select:none;
            transition: transform 0.1s;
        }
        .btn:active{ transform: scale(.98); }
        .btn:disabled{
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn.primary{
            background: linear-gradient(180deg, rgba(29,92,255,.95), rgba(0,57,162,.95));
            border-color: rgba(255,255,255,.18);
        }
        .btn.ghost{
            background: rgba(255,255,255,.06);
        }
        .btn.danger{
            background: rgba(255,59,59,.16);
            border-color: rgba(255,59,59,.35);
        }
        .btn.small{
            height: 44px;
            padding: 0 12px;
            font-size: .95rem;
            border-radius: 12px;
        }

        .nav{
            display:flex;
            justify-content:space-between;
            gap: 12px;
            padding: 14px 16px 16px 16px;
            border-top: 1px solid rgba(255,255,255,.06);
            background: rgba(255,255,255,.02);
        }
        .nav .left, .nav .right{display:flex; gap:10px; flex-wrap:wrap;}

        .counter{
            background: rgba(255,255,255,.04);
            border: 1px solid rgba(255,255,255,.10);
            border-radius: 16px;
            padding: 12px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap: 12px;
        }
        .counter .meta{
            display:flex; flex-direction:column; gap:2px;
            min-width: 0;
        }
        .counter .meta .name{font-weight:800}
        .counter .meta .desc{color: var(--muted); font-size:.9rem}
        .counter .ctl{
            display:flex; align-items:center; gap:10px;
            flex-shrink:0;
        }
        .count{
            min-width: 54px;
            text-align:center;
            font-weight:900;
            font-size: 1.2rem;
        }
        .iconBtn{
            width: 52px;
            height: 52px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(0,0,0,.18);
            color: var(--text);
            font-size: 1.4rem;
            font-weight: 900;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            user-select:none;
            transition: transform 0.1s;
        }
        .iconBtn:active{ transform: scale(.98); }

        .seg{
            display:flex; gap:10px; flex-wrap:wrap;
        }
        .chip{
            padding: 12px 14px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,.14);
            background: rgba(255,255,255,.06);
            color: var(--text);
            cursor:pointer;
            user-select:none;
            font-weight:800;
            transition: all 0.2s;
        }
        .chip:hover{
            background: rgba(255,255,255,.1);
        }
        .chip.active{
            background: linear-gradient(180deg, rgba(29,92,255,.95), rgba(0,57,162,.95));
            border-color: rgba(255,255,255,.18);
        }

        .note{
            color: var(--muted);
            font-size:.9rem;
            line-height:1.35;
        }

        .alert{
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: .95rem;
        }
        .alert.warning{
            background: rgba(255,176,32,.1);
            border-color: rgba(255,176,32,.3);
            color: var(--warning);
        }
        .alert.success{
            background: rgba(33,197,93,.1);
            border-color: rgba(33,197,93,.3);
            color: var(--ok);
        }

        .toast{
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%);
            background: rgba(0,0,0,.85);
            border: 1px solid rgba(255,255,255,.14);
            color: var(--text);
            padding: 12px 14px;
            border-radius: 999px;
            box-shadow: var(--shadow);
            max-width: 92vw;
            display:none;
            z-index: 999;
            font-weight: 600;
        }

        .progress{
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .progress .step{
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,.1);
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }
        .progress .step.active{
            background: linear-gradient(90deg, var(--accent), var(--accent2));
        }
        .progress .step.complete{
            background: var(--ok);
        }
    </style>
</head>
<body>
<header>
    <div class="topbar">
        <div class="brand">
            <div class="t1">1792 Scouting — 2026 REBUILT</div>
            <div class="t2">General • Auto → Teleop → Endgame → Submit</div>
        </div>
        <div class="pill">
            <span id="netDot" class="dot"></span>
            <span id="netText">Offline</span>
        </div>
    </div>
</header>

<main>
    <div class="card">
        <div class="hd">
            <div style="flex: 1;">
                <div class="progress">
                    <div class="step" data-step="0"></div>
                    <div class="step" data-step="1"></div>
                    <div class="step" data-step="2"></div>
                    <div class="step" data-step="3"></div>
                </div>
                <h2 id="screenTitle">Start</h2>
                <p id="screenSubtitle">Enter match info, load teams from an event, then scout.</p>
            </div>
            <button class="btn small ghost" id="btnReset">Reset</button>
        </div>

        <div class="bd">
            <!-- Screen 0: Start -->
            <section class="screen" data-screen="0">
                <div class="grid">
                    <div class="col-6">
                        <label>Student name *</label>
                        <input id="studentName" placeholder="e.g., Elijah" autocomplete="name" />
                    </div>

                    <div class="col-3">
                        <label>Match # *</label>
                        <input id="matchNumber" type="number" min="1" step="1" placeholder="e.g., 12" inputmode="numeric" />
                    </div>

                    <div class="col-3">
                        <label>Alliance *</label>
                        <select id="alliance">
                            <option value="" disabled selected>Select...</option>
                            <option value="Red">Red</option>
                            <option value="Blue">Blue</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <label>Team # *</label>
                        <div class="autocomplete-wrapper">
                            <input id="teamSearch" type="text" placeholder="Type team # or name..." autocomplete="off" />
                            <div id="autocompleteResults" class="autocomplete-results"></div>
                        </div>
                        <div class="note" style="margin-top:8px">
                            Select a team from the dropdown (must be from the 2026 Appleton District Event - 2026wiapp.
                        </div>
                    </div>

                    <div class="col-12" id="queueAlert" style="display:none">
                        <div class="alert warning">
                            ⚠️ You have <span id="queueCount">0</span> queued submissions.
                            <button class="btn small" id="btnResend" style="margin-left: 10px">Resend All</button>
                        </div>
                    </div>

                </div>
            </section>

            <!-- Screen 1: Auto -->
            <section class="screen" data-screen="1" style="display:none">
                <div class="grid">
                    <div class="col-12">
                        <div class="counter">
                            <div class="meta">
                                <div class="name">Auto Fuel scored (active hub)</div>
                                <div class="desc">Each Fuel scored in an active HUB: +1 pt</div>
                            </div>
                            <div class="ctl">
                                <button class="iconBtn" data-dec="autoFuel">−</button>
                                <div class="count" id="autoFuel">0</div>
                                <button class="iconBtn" data-inc="autoFuel">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label>Auto tower *</label>
                        <div class="seg" id="autoTowerSeg">
                            <div class="chip" data-value="NONE">None</div>
                            <div class="chip" data-value="L1">Level 1 (15 pts)</div>
                        </div>
                        <div class="note" style="margin-top:8px">
                            In AUTO, a robot may only earn Tower points for <b>Level 1</b>.
                        </div>
                    </div>
                </div>
            </section>

            <!-- Screen 2: Teleop -->
            <section class="screen" data-screen="2" style="display:none">
                <div class="grid">
                    <div class="col-12">
                        <div class="counter">
                            <div class="meta">
                                <div class="name">Teleop Fuel scored (active hub)</div>
                                <div class="desc">Counts Fuel scored while the alliance hub is active</div>
                            </div>
                            <div class="ctl">
                                <button class="iconBtn" data-dec="teleopFuelActive">−</button>
                                <div class="count" id="teleopFuelActive">0</div>
                                <button class="iconBtn" data-inc="teleopFuelActive">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="counter">
                            <div class="meta">
                                <div class="name">Teleop Fuel scored (inactive hub)</div>
                                <div class="desc">No match points when hub inactive (still useful to track)</div>
                            </div>
                            <div class="ctl">
                                <button class="iconBtn" data-dec="teleopFuelInactive">−</button>
                                <div class="count" id="teleopFuelInactive">0</div>
                                <button class="iconBtn" data-inc="teleopFuelInactive">+</button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label>Robot shuttling? *</label>
                        <select id="shuttling">
                            <option value="" disabled selected>Select...</option>
                            <option value="Great">Great</option>
                            <option value="Good">Good</option>
                            <option value="Average">Average</option>
                            <option value="Bad">Bad</option>
                            <option value="None">None</option>
                        </select>
                    </div>
                </div>
            </section>

            <!-- Screen 3: Endgame + Ranking -->
            <section class="screen" data-screen="3" style="display:none">
                <div class="grid">
                    <div class="col-12">
                        <label>Endgame tower level (TELEOP) *</label>
                        <div class="seg" id="teleopTowerSeg">
                            <div class="chip" data-value="NONE">None</div>
                            <div class="chip" data-value="L1">Level 1 (10 pts)</div>
                            <div class="chip" data-value="L2">Level 2 (20 pts)</div>
                            <div class="chip" data-value="L3">Level 3 (30 pts)</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label>Robot status *</label>
                        <select id="robotStatus">
                            <option value="" disabled selected>Select...</option>
                            <option value="OK">OK</option>
                            <option value="Broke/Stopped">Broke/Stopped</option>
                            <option value="Brownout/Struggled">Brownout/Struggled</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                    </div>

                    <div class="col-6">
                        <label>Defense rating *</label>
                        <select id="defenseRating">
                            <option value="" disabled selected>Select...</option>
                            <option value="None">None</option>
                            <option value="Weak">Weak</option>
                            <option value="Average">Average</option>
                            <option value="Strong">Strong</option>
                            <option value="Elite">Elite</option>
                        </select>
                    </div>

                    <div class="col-6">
                        <label>Speed rating *</label>
                        <div class="seg" id="speedSeg">
                            <div class="chip" data-value="Slow">Slow</div>
                            <div class="chip" data-value="Average">Average</div>
                            <div class="chip" data-value="Fast">Fast</div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label>Rank this robot *</label>
                        <div class="seg" id="rankSeg">
                            <div class="chip" data-value="1">1st (Best)</div>
                            <div class="chip" data-value="2">2nd (Middle)</div>
                            <div class="chip" data-value="3">3rd (Worst)</div>
                        </div>
                        <div class="note" style="margin-top:8px">
                            Rank this robot compared to the other 2 robots in this match on your alliance.
                            Talk to you fellow scouters to make this decision.
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="counter" style="background: rgba(33,197,93,.08); border-color: rgba(33,197,93,.25);">
                            <div class="meta">
                                <div class="name">Estimated match contribution (auto-calculated)</div>
                                <div class="desc">Uses the official 2026 scoring table</div>
                            </div>
                            <div class="ctl">
                                <div class="count" id="estPoints" style="color: var(--ok); font-size: 1.4rem;">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="nav">
            <div class="left">
                <button class="btn ghost" id="btnBack">Back</button>
            </div>
            <div class="right">
                <button class="btn ghost" id="btnNext">Next</button>
                <button class="btn primary" id="btnSubmit" style="display:none">Submit</button>
            </div>
        </div>
    </div>
</main>

<div class="toast" id="toast"></div>

<script>
    (function() {
        "use strict";

        const CONFIG = {
            WEBHOOK_URL: "https://script.google.com/macros/s/AKfycbzG1s4QLO2iym5FnLcWM5sFTUDWnovIm0zMRDBQ4rWCpRxBLpk3STqDr9uRKDWsyR1H/exec",
            TBA_API_KEY: "QbQkb0gqMlzea1xJM9Mo81lCIEFeHcHduBAj4X2M2SJZI7d7rhxXpHepMhseNOdZ",
            EVENT_KEY: "2026wiapp",
            ENABLE_TEAM_LOADING: true
        };

        const TBA_TEAMS_AT_EVENT = (eventKey) =>
            `https://www.thebluealliance.com/api/v3/event/${encodeURIComponent(eventKey)}/teams/simple`;

        const SCREENS = [
            { title: "Start",  subtitle: "Enter match info, load teams from an event, then scout." },
            { title: "Auto",   subtitle: "Track auto fuel + auto tower." },
            { title: "Teleop", subtitle: "Track fuel scored during active/inactive hub time and shuttling." },
            { title: "Endgame",subtitle: "Pick tower level, ratings, rank, then submit." },
        ];

        const state = {
            screen: 0,
            rank: null,
            speed: null,
            selectedTeam: null,
            loadedTeams: [],
            counters: {
                autoFuel: 0,
                teleopFuelActive: 0,
                teleopFuelInactive: 0,
            },
            autoTower: null,
            teleopTower: null,
        };

        const $ = (id) => document.getElementById(id);
        const toastEl = $("toast");

        function toast(msg){
            toastEl.textContent = msg;
            toastEl.style.display = "block";
            clearTimeout(toastEl._t);
            toastEl._t = setTimeout(()=>toastEl.style.display="none", 2500);
        }

        function updateOnline(){
            const online = navigator.onLine;
            $("netDot").classList.toggle("ok", online);
            $("netDot").classList.toggle("bad", !online);
            $("netText").textContent = online ? "Online" : "Offline";
        }
        window.addEventListener("online", updateOnline);
        window.addEventListener("offline", updateOnline);
        updateOnline();

        function updateProgress(){
            document.querySelectorAll(".progress .step").forEach((step, i)=>{
                step.classList.toggle("complete", i < state.screen);
                step.classList.toggle("active", i === state.screen);
            });
        }

        function showScreen(i){
            state.screen = i;

            document.querySelectorAll(".screen").forEach(sec=>{
                sec.style.display = (Number(sec.dataset.screen) === i) ? "block" : "none";
            });

            $("screenTitle").textContent = SCREENS[i].title;
            $("screenSubtitle").textContent = SCREENS[i].subtitle;

            $("btnBack").style.display = (i === 0) ? "none" : "inline-flex";
            $("btnNext").style.display = (i === SCREENS.length - 1) ? "none" : "inline-flex";
            $("btnSubmit").style.display = (i === SCREENS.length - 1) ? "inline-flex" : "none";

            updateProgress();

            if (i === 3) updateEstimate();
        }

        $("btnBack").addEventListener("click", ()=> showScreen(Math.max(0, state.screen - 1)));
        $("btnNext").addEventListener("click", ()=>{
            if (state.screen === 0 && !validateStart()) return;
            if (state.screen === 1 && !validateAuto()) return;
            if (state.screen === 2 && !validateTeleop()) return;

            showScreen(Math.min(SCREENS.length - 1, state.screen + 1));
        });

        $("btnReset").addEventListener("click", ()=>{
            if (!confirm("Reset this scouting entry?")) return;
            resetEntry();
            toast("✓ Reset complete");
        });

        function resetEntry(){
            const name = $("studentName").value;

            $("matchNumber").value = "";
            $("teamSearch").value = "";
            state.selectedTeam = null;
            $("alliance").value = "";
            $("shuttling").value = "";
            $("defenseRating").value = "";
            $("robotStatus").value = "";

            state.counters.autoFuel = 0;
            state.counters.teleopFuelActive = 0;
            state.counters.teleopFuelInactive = 0;

            state.autoTower = null;
            state.teleopTower = null;
            state.speed = null;
            state.rank = null;

            $("studentName").value = name;

            renderCounters();
            renderSegments();
            showScreen(0);
        }

        function clamp(n){ return Math.max(0, Number(n||0)); }

        function renderCounters(){
            $("autoFuel").textContent = state.counters.autoFuel;
            $("teleopFuelActive").textContent = state.counters.teleopFuelActive;
            $("teleopFuelInactive").textContent = state.counters.teleopFuelInactive;
            updateEstimate();
        }

        document.addEventListener("click", (e)=>{
            const incKey = e.target.getAttribute("data-inc");
            const decKey = e.target.getAttribute("data-dec");
            if (incKey){
                state.counters[incKey] = clamp(state.counters[incKey] + 1);
                renderCounters();
            }
            if (decKey){
                state.counters[decKey] = clamp(state.counters[decKey] - 1);
                renderCounters();
            }
        });

        function renderSegments(){
            document.querySelectorAll("#autoTowerSeg .chip").forEach(ch=>{
                ch.classList.toggle("active", ch.dataset.value === state.autoTower);
            });
            document.querySelectorAll("#teleopTowerSeg .chip").forEach(ch=>{
                ch.classList.toggle("active", ch.dataset.value === state.teleopTower);
            });
            document.querySelectorAll("#speedSeg .chip").forEach(ch=>{
                ch.classList.toggle("active", ch.dataset.value === state.speed);
            });
            document.querySelectorAll("#rankSeg .chip").forEach(ch=>{
                ch.classList.toggle("active", ch.dataset.value === state.rank);
            });
        }

        document.querySelectorAll("#autoTowerSeg .chip").forEach(ch=>{
            ch.addEventListener("click", ()=>{
                state.autoTower = ch.dataset.value;
                renderSegments();
                updateEstimate();
            });
        });
        document.querySelectorAll("#teleopTowerSeg .chip").forEach(ch=>{
            ch.addEventListener("click", ()=>{
                state.teleopTower = ch.dataset.value;
                renderSegments();
                updateEstimate();
            });
        });
        document.querySelectorAll("#speedSeg .chip").forEach(ch=>{
            ch.addEventListener("click", ()=>{
                state.speed = ch.dataset.value;
                renderSegments();
            });
        });
        document.querySelectorAll("#rankSeg .chip").forEach(ch=>{
            ch.addEventListener("click", ()=>{
                state.rank = ch.dataset.value;
                renderSegments();
            });
        });

        function towerPointsAuto(level){
            if (level === "L1") return 15;
            return 0;
        }
        function towerPointsTeleop(level){
            if (level === "L1") return 10;
            if (level === "L2") return 20;
            if (level === "L3") return 30;
            return 0;
        }
        function updateEstimate(){
            const pts =
                (state.counters.autoFuel * 1) +
                (state.counters.teleopFuelActive * 1) +
                towerPointsAuto(state.autoTower) +
                towerPointsTeleop(state.teleopTower);

            $("estPoints").textContent = pts;
        }

        function validateStart(){
            const name = $("studentName").value.trim();
            const match = Number($("matchNumber").value);
            const alliance = $("alliance").value;

            if (!name){ toast("⚠️ Enter student name"); return false; }
            if (!match || match < 1){ toast("⚠️ Enter match number"); return false; }
            if (!alliance){ toast("⚠️ Select alliance color"); return false; }
            if (!state.selectedTeam){ toast("⚠️ Select a team from the list"); return false; }

            return true;
        }

        function validateAuto(){
            if (state.autoTower === null){ toast("⚠️ Select auto tower level"); return false; }
            return true;
        }

        function validateTeleop(){
            const shuttling = $("shuttling").value;

            if (!shuttling){ toast("⚠️ Select shuttling rating"); return false; }
            return true;
        }

        function validateEndgame(){
            const defense = $("defenseRating").value;
            const status = $("robotStatus").value;

            if (state.teleopTower === null){ toast("⚠️ Select endgame tower level"); return false; }
            if (!status){ toast("⚠️ Select robot status"); return false; }
            if (!defense){ toast("⚠️ Select defense rating"); return false; }
            if (state.speed === null){ toast("⚠️ Select speed rating"); return false; }
            if (state.rank === null){ toast("⚠️ Rank this robot"); return false; }
            return true;
        }

        async function loadTeams(){
            if (!CONFIG.ENABLE_TEAM_LOADING) {
                console.log("Team loading disabled");
                return;
            }

            try{
                console.log("Loading teams from:", CONFIG.EVENT_KEY);

                const res = await fetch(TBA_TEAMS_AT_EVENT(CONFIG.EVENT_KEY), {
                    method: "GET",
                    headers: { 'X-TBA-Auth-Key': CONFIG.TBA_API_KEY }
                });

                console.log("TBA Response status:", res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    console.error("TBA Error:", errorText);
                    throw new Error(`HTTP ${res.status}`);
                }

                const arr = await res.json();
                console.log("Teams received:", arr.length);

                state.loadedTeams = arr.map(t => ({
                    number: t.team_number,
                    name: t.nickname || t.name || `Team ${t.team_number}`
                })).sort((a,b)=>a.number-b.number);

                console.log(`✓ Loaded ${state.loadedTeams.length} teams`);
                toast(`✓ Loaded ${state.loadedTeams.length} teams`);
            }catch(err){
                console.error("Failed to load teams:", err);
                toast("⚠️ Couldn't load teams - you can still enter team numbers");
            }
        }

        const teamSearchInput = $("teamSearch");
        const autocompleteResults = $("autocompleteResults");
        let selectedIndex = -1;

        teamSearchInput.addEventListener("input", (e) => {
            const query = e.target.value.trim().toLowerCase();

            if (!query) {
                autocompleteResults.classList.remove("show");
                state.selectedTeam = null;
                return;
            }

            const filtered = state.loadedTeams.filter(team => {
                return team.number.toString().includes(query) ||
                    team.name.toLowerCase().includes(query);
            }).slice(0, 10);

            if (filtered.length > 0) {
                renderAutocomplete(filtered);
                autocompleteResults.classList.add("show");
                selectedIndex = -1;
            } else {
                autocompleteResults.classList.remove("show");
            }

            state.selectedTeam = null;
        });

        teamSearchInput.addEventListener("keydown", (e) => {
            const items = autocompleteResults.querySelectorAll(".autocomplete-item");

            if (e.key === "ArrowDown") {
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                updateActiveItem(items);
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateActiveItem(items);
            } else if (e.key === "Enter" && selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            } else if (e.key === "Escape") {
                autocompleteResults.classList.remove("show");
                selectedIndex = -1;
            }
        });

        teamSearchInput.addEventListener("blur", () => {
            setTimeout(() => {
                autocompleteResults.classList.remove("show");
                selectedIndex = -1;
            }, 200);
        });

        function renderAutocomplete(teams) {
            autocompleteResults.innerHTML = teams.map((team, i) => `
            <div class="autocomplete-item" data-team="${team.number}">
                <div class="team-num">${team.number}</div>
                <div class="team-name">${team.name}</div>
            </div>
        `).join("");

            autocompleteResults.querySelectorAll(".autocomplete-item").forEach(item => {
                item.addEventListener("click", () => {
                    const teamNum = item.dataset.team;
                    const team = teams.find(t => t.number.toString() === teamNum);

                    teamSearchInput.value = `${team.number} - ${team.name}`;
                    state.selectedTeam = team.number;
                    autocompleteResults.classList.remove("show");
                });
            });
        }

        function updateActiveItem(items) {
            items.forEach((item, i) => {
                item.classList.toggle("active", i === selectedIndex);
            });

            if (selectedIndex >= 0 && items[selectedIndex]) {
                items[selectedIndex].scrollIntoView({ block: "nearest" });
            }
        }

        $("btnSubmit").addEventListener("click", submit);

        function buildPayload(){
            const getVal = (id, defaultVal = "") => {
                const el = document.getElementById(id);
                return el ? el.value : defaultVal;
            };

            const getText = (id, defaultVal = "0") => {
                const el = document.getElementById(id);
                return el ? el.textContent : defaultVal;
            };

            return {
                timestampISO: new Date().toISOString(),
                studentName: getVal("studentName").trim(),
                eventCode: CONFIG.EVENT_KEY,
                matchNumber: Number(getVal("matchNumber", "0")),
                teamNumber: Number(state.selectedTeam || 0),
                alliance: getVal("alliance"),

                autoFuelActive: Number(state.counters.autoFuel || 0),
                autoTower: state.autoTower || "NONE",
                autoTowerPoints: towerPointsAuto(state.autoTower),

                teleopFuelActive: Number(state.counters.teleopFuelActive || 0),
                teleopFuelInactive: Number(state.counters.teleopFuelInactive || 0),
                shuttling: getVal("shuttling"),

                teleopTower: state.teleopTower || "NONE",
                teleopTowerPoints: towerPointsTeleop(state.teleopTower),
                robotStatus: getVal("robotStatus"),
                defenseRating: getVal("defenseRating"),
                speed: state.speed || "",
                rank: state.rank || "",

                estPoints: Number(getText("estPoints"))
            };
        }

        function queueKey(){ return "scoutQueue_1792_rebuilt_2026"; }

        function getQueue(){
            try{
                return JSON.parse(localStorage.getItem(queueKey()) || "[]");
            }catch{
                return [];
            }
        }
        function setQueue(q){
            localStorage.setItem(queueKey(), JSON.stringify(q));
            updateQueueNote();
        }
        function updateQueueNote(){
            const q = getQueue();
            if (q.length > 0) {
                $("queueAlert").style.display = "block";
                $("queueCount").textContent = q.length;
            } else {
                $("queueAlert").style.display = "none";
            }
        }
        updateQueueNote();

        async function submit(){
            if (!validateStart()) return;
            if (!validateAuto()) return;
            if (!validateTeleop()) return;
            if (!validateEndgame()) return;

            console.log("Starting submit...");
            $("btnSubmit").disabled = true;
            $("btnSubmit").textContent = "Submitting…";

            const payload = buildPayload();
            console.log("Payload:", payload);

            try{
                await postToWebhook(payload);
                console.log("Submit successful");
                toast("✓ Submitted successfully!");
                resetEntry();
            }catch(err){
                console.error("Submit error:", err);
                const q = getQueue();
                q.push(payload);
                setQueue(q);
                toast("⚠️ Submit failed — saved to queue");
            }finally{
                $("btnSubmit").disabled = false;
                $("btnSubmit").textContent = "Submit";
            }
        }

        async function postToWebhook(payloadObj){
            console.log("Posting to webhook");
            const body = "payload=" + encodeURIComponent(JSON.stringify(payloadObj));

            await fetch(CONFIG.WEBHOOK_URL, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
                body: body
            });

            console.log("Request sent (no-cors mode)");
            return true;
        }

        $("btnResend").addEventListener("click", resendQueued);

        async function resendQueued(){
            const q = getQueue();
            if (!q.length){ toast("Queue is empty"); return; }

            $("btnResend").disabled = true;
            $("btnResend").textContent = "Resending…";

            const remaining = [];
            let sent = 0;

            for (const item of q){
                try{
                    await postToWebhook(item);
                    sent++;
                }catch{
                    remaining.push(item);
                }
            }

            setQueue(remaining);
            $("btnResend").disabled = false;
            $("btnResend").textContent = "Resend All";

            if (sent) toast(`✓ Resent ${sent} submission(s)`);
            else toast("❌ No queued items sent");
        }

        renderCounters();
        renderSegments();
        showScreen(0);

        loadTeams();
    })();
</script>
</body>
</html>